{"version":3,"sources":["webpack://WasmAR/webpack/bootstrap","webpack://WasmAR/./faceTracker.js","webpack://WasmAR/./grayscale.js","webpack://WasmAR/./index.js","webpack://WasmAR/./shaders/flip-image.glsl","webpack://WasmAR/./shaders/grayscale.glsl"],"names":["FaceTracker","constructor","width","height","init_callback","_this","_ready","_width","_height","_bboxLength","_landmarksLength","_featuresLength","_rotLength","_transLength","_poseLength","FaceDetectorWasm","then","Module","console","log","onWasmInit","getPoseModel","_Module","initializeShapePredictor","cwrap","detectFaceFeatures","findPose","imBuf","_malloc","landmarksPtr","Uint16Array","BYTES_PER_ELEMENT","download_callback","req","XMLHttpRequest","addEventListener","poseModelProgress","open","responseType","onload","e","payload","response","poseModelInit","send","lengthComputable","downloadEvent","CustomEvent","detail","loaded","total","window","dispatchEvent","data","model","Uint8Array","buf","length","HEAPU8","set","detectFeatures","im","undefined","ptr","features","HEAPU16","buffer","bbox","slice","landmarksRaw","_free","landmarks","getPose","pose","Float64Array","HEAPF64","quat","trans","rotation","translation","GrayScale","source","canvas","_source","_sourceType","_canvas","document","createElement","_flipImageProg","require","_grayscaleProg","glReady","initGL","vertShaderSource","fragShaderSource","gl","getContext","viewport","drawingBufferWidth","drawingBufferHeight","clearColor","clear","COLOR_BUFFER_BIT","vertShader","createShader","VERTEX_SHADER","fragShader","FRAGMENT_SHADER","shaderSource","compileShader","program","createProgram","attachShader","linkProgram","useProgram","vertices","Float32Array","createBuffer","bindBuffer","ARRAY_BUFFER","bufferData","STATIC_DRAW","positionLocation","getAttribLocation","vertexAttribPointer","FLOAT","enableVertexAttribArray","texture","createTexture","activeTexture","TEXTURE0","bindTexture","TEXTURE_2D","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","TEXTURE_MIN_FILTER","LINEAR","TEXTURE_MAG_FILTER","pixelBuf","grayBuf","getFrame","texImage2D","RGBA","UNSIGNED_BYTE","drawArrays","TRIANGLES","readPixels","j","k","i","requestStream","Promise","resolve","reject","navigator","mediaDevices","getUserMedia","audio","video","ideal","aspectRatio","facingMode","stream","srcObject","onloadedmetadata","play","catch","err","warn","stats","grayscale","faceTracker","overlayCanv","OVERLAY_COLOR","initStats","Stats","showPanel","getElementById","appendChild","domElement","setVideoStyle","elem","style","position","top","left","setupVideo","setAttribute","zIndex","body","drawPolyline","start","end","closed","overlayCtx","beginPath","strokeStyle","lineWidth","moveTo","lineTo","stroke","writeOverlayText","text","clearRect","font","textAlign","fillStyle","fillText","drawBbox","drawFeatures","landmarksFormatted","l","push","processVideo","begin","requestAnimationFrame","progress","Math","round","id"],"mappings":"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","file":"arena-face-tracker.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./index.js\");\n","export class FaceTracker {\n    constructor(width, height, init_callback) {\n        let _this = this;\n        this._ready = false;\n\n        this._width = width;\n        this._height = height;\n\n        this._bboxLength = 4;\n        this._landmarksLength = 2 * 68;\n        this._featuresLength = this._landmarksLength + this._bboxLength;\n        this._rotLength = 4;\n        this._transLength = 3;\n        this._poseLength = this._rotLength + this._transLength;\n\n        FaceDetectorWasm().then(function (Module) {\n            console.log(\"Face Detector WASM module loaded.\");\n            _this.onWasmInit(Module);\n            _this.getPoseModel();\n            if (init_callback) init_callback();\n        });\n    }\n\n    onWasmInit(Module) {\n        this._Module = Module;\n\n        this.initializeShapePredictor = this._Module.cwrap(\"pose_model_init\", null, [\"number\", \"number\"]);\n        this.detectFaceFeatures = this._Module.cwrap(\"detect_face_features\", \"number\", [\"number\", \"number\", \"number\"]);\n        this.findPose = this._Module.cwrap(\"get_pose\", \"number\", [\"number\", \"number\", \"number\"]);\n\n        this.imBuf = this._Module._malloc(this._width * this._height);\n        this.landmarksPtr = this._Module._malloc(this._landmarksLength * Uint16Array.BYTES_PER_ELEMENT);\n    }\n\n    getPoseModel(download_callback) {\n        const req = new XMLHttpRequest();\n        req.addEventListener('progress', this.poseModelProgress);\n        req.open(\"GET\", \"/shape_predictor_68_face_landmarks_compressed.dat\", true);\n        req.responseType = \"arraybuffer\";\n        req.onload = e => {\n            const payload = req.response;\n            if (payload) {\n                this.poseModelInit(payload);\n                this._ready = true;\n            }\n        }\n        req.send(null);\n    }\n\n    poseModelProgress(e) {\n        if (e.lengthComputable) {\n            // var percentage = (e.loaded / e.total) * 100;\n            const downloadEvent = new CustomEvent(\"faceModelDownloadProgress\", {\n                detail: (e.loaded / e.total) * 100\n            });\n            window.dispatchEvent(downloadEvent);\n        }\n        else {\n            console.log(\"Cannot log face model download progress!\");\n        }\n    }\n\n    poseModelInit(data) {\n        const model = new Uint8Array(data);\n        const buf = this._Module._malloc(model.length);\n        this._Module.HEAPU8.set(model, buf);\n        this.initializeShapePredictor(buf, model.length);\n    }\n\n    detectFeatures(im) {\n        if (!this._ready) undefined;\n\n        this._Module.HEAPU8.set(im, this.imBuf);\n\n        // console.time(\"features\");\n        const ptr = this.detectFaceFeatures(this.imBuf, this._width, this._height);\n        // console.timeEnd(\"features\");\n        let features = new Uint16Array(this._Module.HEAPU16.buffer, ptr, this._featuresLength);\n\n        const bbox = features.slice(0, this._bboxLength);\n        const landmarksRaw = features.slice(this._bboxLength, this._featuresLength);\n\n        this._Module._free(ptr);\n\n        return {\n            bbox: bbox,\n            landmarks: landmarksRaw\n        };\n    }\n\n    getPose(landmarks) {\n        if (!this._ready) return undefined;\n\n        this._Module.HEAPU16.set(landmarks, this.landmarksPtr / Uint16Array.BYTES_PER_ELEMENT);\n\n        // console.time(\"pose\");\n        const ptr = this.findPose(this.landmarksPtr, this._width, this._height);\n        // console.timeEnd(\"pose\");\n\n        let pose = new Float64Array(this._Module.HEAPF64.buffer, ptr, this._featuresLength);\n\n        const quat = pose.slice(0, this._rotLength);\n        const trans = pose.slice(this._rotLength, this._poseLength);\n\n        this._Module._free(ptr);\n\n        return {\n            rotation: quat,\n            translation: trans\n        };\n    }\n}\n","export class GrayScale\n{\n    constructor(source, width, height, canvas) {\n        this._source = source;\n        this._sourceType = typeof this._source;\n        this._width = width;\n        this._height = height;\n        this._canvas = canvas ? canvas : document.createElement(\"canvas\");\n        this._canvas.width = width;\n        this._canvas.height = height;\n\n        this._flipImageProg = require(\"./shaders/flip-image.glsl\");\n        this._grayscaleProg = require(\"./shaders/grayscale.glsl\");\n        this.glReady = false;\n        this.initGL(this._flipImageProg, this._grayscaleProg);\n    }\n\n    initGL(vertShaderSource, fragShaderSource) {\n        this.gl = this._canvas.getContext(\"webgl\");\n\n        this.gl.viewport(0, 0, this.gl.drawingBufferWidth, this.gl.drawingBufferHeight);\n        this.gl.clearColor(0.1, 0.1, 0.1, 1.0);\n        this.gl.clear(this.gl.COLOR_BUFFER_BIT);\n\n        const vertShader = this.gl.createShader(this.gl.VERTEX_SHADER);\n        const fragShader = this.gl.createShader(this.gl.FRAGMENT_SHADER);\n\n        this.gl.shaderSource(vertShader, vertShaderSource);\n        this.gl.shaderSource(fragShader, fragShaderSource);\n\n        this.gl.compileShader(vertShader);\n        this.gl.compileShader(fragShader);\n\n        const program = this.gl.createProgram();\n        this.gl.attachShader(program, vertShader);\n        this.gl.attachShader(program, fragShader);\n\n        this.gl.linkProgram(program);\n\n        this.gl.useProgram(program);\n\n        const vertices = new Float32Array([\n            -1, -1,\n            -1,  1,\n             1,  1,\n            -1, -1,\n             1,  1,\n             1, -1,\n        ]);\n\n        const buffer = this.gl.createBuffer();\n        this.gl.bindBuffer(this.gl.ARRAY_BUFFER, buffer);\n        this.gl.bufferData(this.gl.ARRAY_BUFFER, vertices, this.gl.STATIC_DRAW);\n\n        const positionLocation = this.gl.getAttribLocation(program, \"position\");\n\n        this.gl.vertexAttribPointer(positionLocation, 2, this.gl.FLOAT, false, 0, 0);\n        this.gl.enableVertexAttribArray(positionLocation);\n\n        const texture = this.gl.createTexture();\n        this.gl.activeTexture(this.gl.TEXTURE0);\n        this.gl.bindTexture(this.gl.TEXTURE_2D, texture);\n\n        // if either dimension of image is not a power of 2\n        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_S, this.gl.CLAMP_TO_EDGE);\n        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_T, this.gl.CLAMP_TO_EDGE);\n        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MIN_FILTER, this.gl.LINEAR);\n        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MAG_FILTER, this.gl.LINEAR);\n\n        this.glReady = true;\n        this.pixelBuf = new Uint8Array(this.gl.drawingBufferWidth * this.gl.drawingBufferHeight * 4);\n        this.grayBuf = new Uint8Array(this.gl.drawingBufferWidth * this.gl.drawingBufferHeight);\n    }\n\n    getFrame() {\n        if (!this.glReady) return undefined;\n\n        this.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA, this.gl.RGBA, this.gl.UNSIGNED_BYTE, this._source);\n        this.gl.drawArrays(this.gl.TRIANGLES, 0, 6);\n\n        this.gl.readPixels(0, 0, this.gl.drawingBufferWidth, this.gl.drawingBufferHeight, this.gl.RGBA, this.gl.UNSIGNED_BYTE, this.pixelBuf);\n\n        // webgl returns flipped image, so we will need to flip image buffer to return the correct orientation\n        let j = this.grayBuf.length - this.gl.drawingBufferWidth, k = 0;\n        for (let i = 0; i < this.pixelBuf.length; i += 4) {\n            this.grayBuf[j+k] = this.pixelBuf[i];\n            k++;\n            if (k == this.gl.drawingBufferWidth) {\n                j -= this.gl.drawingBufferWidth;\n                k = 0;\n            }\n        }\n        return this.grayBuf;\n    }\n\n    requestStream() {\n        return new Promise((resolve, reject) => {\n            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia)\n                return reject();\n\n            navigator.mediaDevices.getUserMedia({\n                audio: false,\n                video: {\n                    width: { ideal: this._width },\n                    height: { ideal: this._height },\n                    aspectRatio: { ideal: this._width / this._height },\n                    facingMode: \"environment\"\n                }\n            })\n            .then(stream => {\n                this._source.srcObject = stream;\n                this._source.onloadedmetadata = e => {\n                    this._source.play();\n                    resolve(this._source, stream);\n                };\n            })\n            .catch(err => {\n                console.warn(\"ERROR: \" + err);\n            });\n        });\n    }\n}\n","import { GrayScale } from \"./grayscale.js\"\nimport { FaceTracker } from \"./faceTracker.js\"\n\nlet width = 320; // window.innerWidth;\nlet height = 240; // window.innerHeight;\n\nlet stats = null;\nlet grayscale = null;\nlet faceTracker = null;\n\nlet overlayCanv = null;\n\nconst OVERLAY_COLOR = \"#ef2d5e\";\n\nfunction initStats() {\n    stats = new Stats();\n    stats.showPanel(0);\n    document.getElementById(\"stats\").appendChild(stats.domElement);\n}\n\nfunction setVideoStyle(elem) {\n    elem.style.position = \"absolute\";\n    elem.style.top = 0;\n    elem.style.left = 0;\n}\n\nfunction setupVideo() {\n    return new Promise((resolve, reject) => {\n        let video = document.createElement(\"video\");\n        video.setAttribute(\"autoplay\", \"\");\n        video.setAttribute(\"muted\", \"\");\n        video.setAttribute(\"playsinline\", \"\");\n        // document.body.appendChild(video);\n\n        let canvas = document.createElement(\"canvas\");\n        canvas.style.zIndex = 9998;\n        setVideoStyle(canvas);\n        document.body.appendChild(canvas);\n\n        grayscale = new GrayScale(video, width, height, canvas);\n        grayscale.requestStream()\n            .then(() => {\n                resolve();\n            })\n            .catch(err => {\n                console.warn(\"ERROR: \" + err);\n                reject();\n            });\n    });\n}\n\nfunction drawPolyline(landmarks, start, end, closed) {\n    const overlayCtx = overlayCanv.getContext(\"2d\");\n\n    overlayCtx.beginPath();\n    overlayCtx.strokeStyle = 'blue';\n    overlayCtx.lineWidth = 1;\n\n    overlayCtx.moveTo(landmarks[start][0], landmarks[start][1]);\n    for (let i = start + 1; i <= end; i++) {\n        overlayCtx.lineTo(landmarks[i][0], landmarks[i][1]);\n    }\n    if (closed) {\n        overlayCtx.lineTo(landmarks[start][0], landmarks[start][1]);\n    }\n    overlayCtx.stroke();\n}\n\nfunction writeOverlayText(text) {\n    const overlayCtx = overlayCanv.getContext(\"2d\");\n    overlayCtx.clearRect(\n        0, 0,\n        width,\n        height\n    );\n    overlayCtx.font = \"17px Arial\";\n    overlayCtx.textAlign = \"center\";\n    overlayCtx.fillStyle = OVERLAY_COLOR;\n    overlayCtx.fillText(text, overlayCanv.width/2, overlayCanv.height/8);\n}\n\nfunction drawBbox(bbox) {\n    const overlayCtx = overlayCanv.getContext(\"2d\");\n\n    overlayCtx.beginPath();\n    overlayCtx.strokeStyle = \"red\";\n    overlayCtx.lineWidth = 1;\n\n    // [x1,y1,x2,y2]\n    overlayCtx.moveTo(bbox[0], bbox[1]);\n    overlayCtx.lineTo(bbox[0], bbox[3]);\n    overlayCtx.lineTo(bbox[2], bbox[3]);\n    overlayCtx.lineTo(bbox[2], bbox[1]);\n    overlayCtx.lineTo(bbox[0], bbox[1]);\n\n    overlayCtx.stroke();\n}\n\nfunction drawFeatures(features) {\n    const bbox = features.bbox\n    const landmarks = features.landmarks;\n\n    const overlayCtx = overlayCanv.getContext(\"2d\");\n    overlayCtx.clearRect(\n        0, 0,\n        width,\n        height\n    );\n\n    let landmarksFormatted = [];\n    for (let i = 0; i < landmarks.length; i += 2) {\n        const l = [landmarks[i], landmarks[i+1]];\n        landmarksFormatted.push(l);\n    }\n\n    drawBbox(bbox);\n\n    drawPolyline(landmarksFormatted, 0,  16, false);   // jaw\n    drawPolyline(landmarksFormatted, 17, 21, false);   // left eyebrow\n    drawPolyline(landmarksFormatted, 22, 26, false);   // right eyebrow\n    drawPolyline(landmarksFormatted, 27, 30, false);   // nose bridge\n    drawPolyline(landmarksFormatted, 30, 35, true);    // lower nose\n    drawPolyline(landmarksFormatted, 36, 41, true);    // left eye\n    drawPolyline(landmarksFormatted, 42, 47, true);    // right Eye\n    drawPolyline(landmarksFormatted, 48, 59, true);    // outer lip\n    drawPolyline(landmarksFormatted, 60, 67, true);    // inner lip\n}\n\nfunction processVideo() {\n    stats.begin();\n\n    const features = faceTracker.detectFeatures(grayscale.getFrame());\n\n    const pose = faceTracker.getPose(features.landmarks);\n    // const rotation = pose.rotation;\n    // const translation = pose.translation;\n\n    if (features) drawFeatures(features);\n\n    stats.end();\n\n    requestAnimationFrame(processVideo);\n}\n\nwindow.addEventListener(\"faceModelDownloadProgress\", e => {\n    const progress = Math.round(e.detail * 100) / 100;\n    writeOverlayText(`Downloading Face Model: ${progress}%`);\n}, false);\n\nwindow.onload = () => {\n    overlayCanv = document.createElement(\"canvas\");\n    setVideoStyle(overlayCanv);\n    overlayCanv.id = \"overlay\";\n    overlayCanv.width = width;\n    overlayCanv.height = height;\n    overlayCanv.style.zIndex = 9999;\n    document.body.appendChild(overlayCanv);\n\n    faceTracker = new FaceTracker(width, height,\n        () => {\n            initStats();\n            setupVideo().then(() => {\n                requestAnimationFrame(processVideo);\n            });\n        }\n    );\n}\n","module.exports = \"attribute vec2 position;\\nvarying vec2 tex_coords;\\nvoid main(void) {\\ntex_coords = (position + 1.0) / 2.0;\\ntex_coords.y = 1.0 - tex_coords.y;\\ngl_Position = vec4(position, 0.0, 1.0);\\n}\"","module.exports = \"precision highp float;\\nuniform sampler2D u_image;\\nvarying vec2 tex_coords;\\nconst vec3 g = vec3(0.299, 0.587, 0.114);\\nvoid main(void) {\\nvec4 color = texture2D(u_image, tex_coords);\\nfloat gray = dot(color.rgb, g);\\ngl_FragColor = vec4(vec3(gray), 1.0);\\n}\""],"sourceRoot":""}